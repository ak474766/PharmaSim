{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/khana/OneDrive/Desktop/PharmaSim/src/app/actions/ai.ts"],"sourcesContent":["'use server';\n\nimport { GoogleGenerativeAI } from '@google/generative-ai';\n\n// ============================================================================\n// Type Definitions - Strong typing for all AI responses (like JSON schema)\n// ============================================================================\n\n/** Response from molecule analysis */\n// Update Interface\nexport interface MoleculeAnalysisResult {\n    analysis: string;\n    efficacy: number;\n    safety: number;\n    feedback: string;\n    visualPrompt: string;\n}\n\n\n\n/** Response from quiz question generation */\nexport interface QuizQuestionResult {\n    text: string;\n    options: string[];\n    correctIndex: number;\n    explanation: string;\n}\n\n/** Phase data within a roadmap */\nexport interface RoadmapPhase {\n    name: string;\n    duration: string;\n    description: string;\n    keyActivities: string[];\n    risks: string;\n}\n\n/** Response from trial roadmap generation */\nexport interface TrialRoadmapResult {\n    summary: string;\n    phases: RoadmapPhase[];\n    successProbability: number;\n}\n\n/** Choice within a trial event */\nexport interface TrialEventChoice {\n    text: string;\n    budgetEffect: number;\n    efficacyEffect: number;\n    safetyEffect: number;\n    outcomeText: string;\n}\n\n/** Response from trial event generation */\nexport interface TrialEventResult {\n    title: string;\n    description: string;\n    choices: TrialEventChoice[];\n    isPhaseComplete: boolean;\n}\n\n// ============================================================================\n// AI Configuration\n// ============================================================================\n\nconst API_KEY = process.env.GOOGLE_GENAI_API_KEY || process.env.NEXT_PUBLIC_GOOGLE_GENAI_API_KEY || '';\nconst genAI = API_KEY ? new GoogleGenerativeAI(API_KEY) : null;\nconst model = genAI?.getGenerativeModel({ model: 'gemini-2.5-flash' });\n\n// Config for consistent response format\nconst MODEL_CONFIG = {\n    responseMimeType: 'text/plain',\n};\n\n// ============================================================================\n// Error Handling Utilities\n// ============================================================================\n\ninterface AIError {\n    type: 'api_key_missing' | 'quota_exceeded' | 'rate_limit' | 'ai_service_error' | 'parse_error' | 'unknown';\n    message: string;\n    originalError?: unknown;\n}\n\n/**\n * Categorize errors for consistent handling (like the example code)\n */\nfunction categorizeError(error: unknown): AIError {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n\n    // API Key errors\n    if (errorMessage.includes('API_KEY') || errorMessage.includes('authentication') || errorMessage.includes('Missing API Key')) {\n        return {\n            type: 'api_key_missing',\n            message: 'AI Service Unavailable: API key is invalid or missing.',\n            originalError: error\n        };\n    }\n\n    // Quota/Rate limit errors\n    if (errorMessage.includes('quota') || errorMessage.includes('RESOURCE_EXHAUSTED')) {\n        return {\n            type: 'quota_exceeded',\n            message: 'API quota exceeded. Please try again later.',\n            originalError: error\n        };\n    }\n\n    if (errorMessage.includes('rate limit') || errorMessage.includes('429')) {\n        return {\n            type: 'rate_limit',\n            message: 'Rate limit reached. Please wait a moment and try again.',\n            originalError: error\n        };\n    }\n\n    // AI Service errors\n    if (errorMessage.includes('generateContent') || errorMessage.includes('model') || errorMessage.includes('503')) {\n        return {\n            type: 'ai_service_error',\n            message: 'AI service is currently unavailable. Please try again later.',\n            originalError: error\n        };\n    }\n\n    // JSON Parse errors\n    if (errorMessage.includes('JSON') || errorMessage.includes('parse') || errorMessage.includes('Unexpected token')) {\n        return {\n            type: 'parse_error',\n            message: 'Failed to parse AI response. Please try again.',\n            originalError: error\n        };\n    }\n\n    return {\n        type: 'unknown',\n        message: errorMessage || 'An unexpected error occurred.',\n        originalError: error\n    };\n}\n\n/**\n * Helper to clean and parse JSON from AI response\n */\nfunction parseAIResponse<T>(text: string): T {\n    const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\n    return JSON.parse(jsonStr) as T;\n}\n\n/**\n * Check if API is configured\n */\nfunction ensureAPIConfigured(): void {\n    if (!API_KEY || !model) {\n        throw new Error('AI Service Unavailable: Missing API Key');\n    }\n}\n\n// ============================================================================\n// AI Action Functions with Strong Typing\n// ============================================================================\n\n/**\n * Analyze a molecule modification\n * Returns structured analysis with efficacy and safety scores\n */\nexport async function analyzeMoleculeAction(\n    moleculeName: string,\n    atomCount: number,\n    userModifications: string\n): Promise<MoleculeAnalysisResult> {\n    ensureAPIConfigured();\n\n    const prompt = `\n        Act as a Pharmacy Professor.\n        A student has submitted a modified version of ${moleculeName}.\n        Data:\n        - Atom Count: ${atomCount}\n        - Student's Note/Mod: \"${userModifications}\"\n        \n        Analyze this. \n        1. What is the pharmacological impact?\n        2. Estimate specific Efficacy (0-100) and Safety (0-100) scores based on this change (be realistic based on med chem principles).\n        3. Provide 2 sentences of constructive feedback.\n        4. Generate a 'visualPrompt' for an Image Generator (Stable Diffusion/DALL-E) to visualize this SPECIFIC molecule. Describe its color, key functional groups (e.g. 'glowing benzene rings'), and a scientific background.\n        \n        Respond in JSON format:\n        {\n            \"analysis\": \"...\",\n            \"efficacy\": number,\n            \"safety\": number,\n            \"feedback\": \"...\",\n            \"visualPrompt\": \"A futuristic 3D render of...\"\n        }\n    `;\n\n    try {\n        const result = await model!.generateContent(prompt);\n        const response = await result.response;\n        const text = response.text();\n        return parseAIResponse<MoleculeAnalysisResult>(text);\n    } catch (error: unknown) {\n        const categorized = categorizeError(error);\n        console.error(`AI Analysis Failed [${categorized.type}]:`, categorized.message);\n        throw new Error(categorized.message);\n    }\n}\n\n/**\n * Generate a quiz question\n * Returns null if generation fails (allows fallback to local questions)\n */\nexport async function generateQuestionAction(\n    topic: string,\n    level: number\n): Promise<QuizQuestionResult | null> {\n    if (!API_KEY || !model) {\n        return null; // Fail silently for quiz - use local fallback\n    }\n\n    const prompt = `\n        Generate a single multiple-choice question for a B.Pharma student.\n        Topic: ${topic}\n        Difficulty Level: ${level} (1=Freshman, 8=Final Year).\n        \n        Respond in JSON:\n        {\n            \"text\": \"Question text...\",\n            \"options\": [\"A\", \"B\", \"C\", \"D\"],\n            \"correctIndex\": 0, // 0-3\n            \"explanation\": \"Why...\"\n        }\n    `;\n\n    try {\n        const result = await model.generateContent(prompt);\n        const response = await result.response;\n        const text = response.text();\n        return parseAIResponse<QuizQuestionResult>(text);\n    } catch (error: unknown) {\n        const categorized = categorizeError(error);\n        console.error(`AI Question Gen Failed [${categorized.type}]:`, categorized.message);\n        return null; // Return null to fallback to local questions\n    }\n}\n\n/**\n * Generate clinical trial roadmap\n * Returns comprehensive phase breakdown for drug development\n */\nexport async function generateTrialRoadmapAction(\n    moleculeName: string,\n    efficacy: number,\n    safety: number\n): Promise<TrialRoadmapResult> {\n    ensureAPIConfigured();\n\n    const prompt = `\n        You are a pharmaceutical regulatory expert. Generate detailed clinical trial phase content for a drug candidate called \"${moleculeName}\".\n        \n        Current stats:\n        - Efficacy Score: ${efficacy}%\n        - Safety Score: ${safety}%\n        \n        Generate content for each trial phase. Be realistic and educational.\n        \n        Respond in JSON format:\n        {\n            \"summary\": \"Brief 2-sentence overview of the drug and its potential\",\n            \"phases\": [\n                {\n                    \"name\": \"Preclinical\",\n                    \"duration\": \"6-12 months\",\n                    \"description\": \"Detailed description of what happens in this phase (2-3 sentences)\",\n                    \"keyActivities\": [\"Activity 1\", \"Activity 2\", \"Activity 3\"],\n                    \"risks\": \"Main risk for this phase based on the drug's stats\"\n                },\n                {\n                    \"name\": \"Phase I Clinical Trial\",\n                    \"duration\": \"1-2 years\",\n                    \"description\": \"Description...\",\n                    \"keyActivities\": [\"...\"],\n                    \"risks\": \"...\"\n                },\n                {\n                    \"name\": \"Phase II Clinical Trial\",\n                    \"duration\": \"2-3 years\",\n                    \"description\": \"Description...\",\n                    \"keyActivities\": [\"...\"],\n                    \"risks\": \"...\"\n                },\n                {\n                    \"name\": \"Phase III & FDA Review\",\n                    \"duration\": \"3-5 years\",\n                    \"description\": \"Description...\",\n                    \"keyActivities\": [\"...\"],\n                    \"risks\": \"...\"\n                }\n            ],\n            \"successProbability\": number (0-100 based on efficacy and safety scores)\n        }\n    `;\n\n    try {\n        const result = await model!.generateContent(prompt);\n        const response = await result.response;\n        const text = response.text();\n        return parseAIResponse<TrialRoadmapResult>(text);\n    } catch (error: unknown) {\n        const categorized = categorizeError(error);\n        console.error(`AI Roadmap Gen Failed [${categorized.type}]:`, categorized.message);\n        throw new Error(categorized.message);\n    }\n}\n\n/**\n * Generate a trial event for the simulation\n * Returns event with choices and consequences\n */\nexport async function generateTrialEventAction(\n    moleculeName: string,\n    phaseName: string,\n    phaseDescription: string,\n    currentStats: { budget: number; efficacy: number; safety: number },\n    previousEvents: string[],\n    chemicalFeatures?: string\n): Promise<TrialEventResult> {\n    ensureAPIConfigured();\n\n    const chemicalContext = chemicalFeatures\n        ? `\\n        Chemical Structure Context: ${chemicalFeatures}\\n        IMPORTANT: Incorporate these chemical features into the event (e.g., if it has a Ring Strain warning, create a stability or side-effect event related to that).`\n        : '';\n\n    const prompt = `\n        You are a pharmaceutical regulatory simulation AI. Generate a realistic trial event for a drug called \"${moleculeName}\".\n\n        Current Phase: ${phaseName}\n        Phase Description: ${phaseDescription}\n        ${chemicalContext}\n        \n        Current Trial Stats:\n        - Budget: $${(currentStats.budget / 1000000).toFixed(1)}M remaining\n        - Efficacy Score: ${currentStats.efficacy}%\n        - Safety Score: ${currentStats.safety}%\n\n        Previous events in this trial: ${previousEvents.length > 0 ? previousEvents.join(', ') : 'None yet'}\n\n        Generate ONE new event for this phase. The event should be:\n        1. Realistic for pharmaceutical trials\n        2. Educational about the drug development process\n        3. Have meaningful consequences based on choices\n        4. If chemical context is provided, USE IT to make the event specific to this molecule's structure.\n\n        Respond in JSON format:\n        {\n            \"title\": \"Short event title\",\n            \"description\": \"2-3 sentence detailed description of the situation\",\n            \"choices\": [\n                {\n                    \"text\": \"Choice A (brief description)\",\n                    \"budgetEffect\": number (negative for costs, positive for grants, in dollars),\n                    \"efficacyEffect\": number (-20 to +20),\n                    \"safetyEffect\": number (-20 to +20),\n                    \"outcomeText\": \"What happens when this choice is made (2 sentences)\"\n                },\n                {\n                    \"text\": \"Choice B (brief description)\",\n                    \"budgetEffect\": number,\n                    \"efficacyEffect\": number,\n                    \"safetyEffect\": number,\n                    \"outcomeText\": \"What happens\"\n                }\n            ],\n            \"isPhaseComplete\": boolean (true if this is a good point to advance to next phase based on stats)\n        }\n    `;\n\n    try {\n        const result = await model!.generateContent(prompt);\n        const response = await result.response;\n        const text = response.text();\n        return parseAIResponse<TrialEventResult>(text);\n    } catch (error: unknown) {\n        const categorized = categorizeError(error);\n        console.error(`AI Event Gen Failed [${categorized.type}]:`, categorized.message);\n        throw new Error(categorized.message);\n    }\n}\n\n/**\n * Generate a full scenario (3 events) for a specific phase\n * This allows pre-generating the entire trial for instant playback\n */\nexport async function generatePhaseScenariosAction(\n    moleculeName: string,\n    phaseName: string,\n    phaseDescription: string,\n    chemicalFeatures?: string\n): Promise<TrialEventResult[]> {\n    ensureAPIConfigured();\n\n    const chemicalContext = chemicalFeatures\n        ? `\\n        Chemical Structure Context: ${chemicalFeatures}\\n        IMPORTANT: Incorporate these chemical features into the events.`\n        : '';\n\n    const prompt = `\n        You are a pharmaceutical regulatory simulation AI. \n        Generate 3 distinct, sequential trial events for the \"${phaseName}\" of a drug called \"${moleculeName}\".\n\n        Phase Description: ${phaseDescription}\n        ${chemicalContext}\n        \n        Requirements:\n        1. Generate exactly 3 events.\n        2. Events should progress in severity or complexity.\n        3. Event 1: Early phase issue/discovery.\n        4. Event 2: Mid-phase complication.\n        5. Event 3: Late-phase critical decision.\n        6. Use the chemical context to make specific, scientific scenarios (e.g. solubility issues, metabolic toxicity).\n\n        Respond in a JSON array format (valid JSON):\n        [\n            {\n                \"title\": \"Short event title\",\n                \"description\": \"2-3 sentence detailed description\",\n                \"choices\": [\n                    {\n                        \"text\": \"Choice A (Risky/Cheap)\",\n                        \"budgetEffect\": number (e.g. -100000),\n                        \"efficacyEffect\": number (-10 to +10),\n                        \"safetyEffect\": number (-10 to +10),\n                        \"outcomeText\": \"Outcome description\"\n                    },\n                    {\n                        \"text\": \"Choice B (Safe/Expensive)\",\n                        \"budgetEffect\": number,\n                        \"efficacyEffect\": number,\n                        \"safetyEffect\": number,\n                        \"outcomeText\": \"Outcome description\"\n                    }\n                ],\n                \"isPhaseComplete\": false\n            },\n            ... (2 more, last one can have isPhaseComplete: true)\n        ]\n    `;\n\n    try {\n        const result = await model!.generateContent(prompt);\n        const response = await result.response;\n        const text = response.text();\n        // Since we expect an array, parse it properly\n        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\n        // Sometimes the AI might wrap it in { events: [...] } or just [...]\n        // We will assume array but handle object wrapper if needed\n        try {\n            const parsed = JSON.parse(jsonStr);\n            if (Array.isArray(parsed)) return parsed as TrialEventResult[];\n            // @ts-ignore\n            if (parsed.events && Array.isArray(parsed.events)) return parsed.events as TrialEventResult[];\n            return [parsed] as TrialEventResult[]; // Fallback for single object\n        } catch (e) {\n            throw new Error('Failed to parse AI array response');\n        }\n    } catch (error: unknown) {\n        const categorized = categorizeError(error);\n        console.error(`AI Phase Scenario Gen Failed [${categorized.type}]:`, categorized.message);\n        throw new Error(categorized.message);\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 395, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/khana/OneDrive/Desktop/PharmaSim/src/app/api/ai/analyze-molecule/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { analyzeMoleculeAction, MoleculeAnalysisResult } from '@/app/actions/ai';\n\n// ============================================================================\n// Type Definitions for API Response\n// ============================================================================\n\ninterface SuccessResponse extends MoleculeAnalysisResult {\n    success: true;\n}\n\ninterface ErrorResponse {\n    success: false;\n    error: string;\n    errorType: 'validation_error' | 'api_key_error' | 'quota_exceeded' | 'rate_limit' | 'ai_service_error' | 'analysis_failed';\n    message: string;\n}\n\ntype APIResponse = SuccessResponse | ErrorResponse;\n\n// ============================================================================\n// Error Categorization\n// ============================================================================\n\nfunction categorizeError(error: unknown): ErrorResponse {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n\n    if (errorMessage.includes('API') && (errorMessage.includes('key') || errorMessage.includes('Key') || errorMessage.includes('Missing'))) {\n        return {\n            success: false,\n            error: 'api_key_error',\n            errorType: 'api_key_error',\n            message: 'AI service configuration error. Please check API key settings.',\n        };\n    }\n\n    if (errorMessage.includes('quota') || errorMessage.includes('RESOURCE_EXHAUSTED')) {\n        return {\n            success: false,\n            error: 'quota_exceeded',\n            errorType: 'quota_exceeded',\n            message: 'API quota exceeded. Please try again later.',\n        };\n    }\n\n    if (errorMessage.includes('rate limit') || errorMessage.includes('429')) {\n        return {\n            success: false,\n            error: 'rate_limit',\n            errorType: 'rate_limit',\n            message: 'Rate limit reached. Please wait and try again.',\n        };\n    }\n\n    if (errorMessage.includes('unavailable') || errorMessage.includes('service')) {\n        return {\n            success: false,\n            error: 'ai_service_error',\n            errorType: 'ai_service_error',\n            message: 'AI service is currently unavailable.',\n        };\n    }\n\n    return {\n        success: false,\n        error: 'analysis_failed',\n        errorType: 'analysis_failed',\n        message: errorMessage || 'Failed to analyze molecule. Please try again.',\n    };\n}\n\nfunction getStatusCode(errorType: ErrorResponse['errorType']): number {\n    switch (errorType) {\n        case 'validation_error': return 400;\n        case 'api_key_error': return 503;\n        case 'quota_exceeded': return 429;\n        case 'rate_limit': return 429;\n        case 'ai_service_error': return 503;\n        default: return 500;\n    }\n}\n\n// ============================================================================\n// POST Handler\n// ============================================================================\n\nexport async function POST(req: Request): Promise<NextResponse<APIResponse>> {\n    try {\n        const body = await req.json();\n        const { moleculeName, atomCount, userModifications } = body || {};\n\n        // Input validation\n        if (!moleculeName || typeof moleculeName !== 'string') {\n            return NextResponse.json({\n                success: false,\n                error: 'validation_error',\n                errorType: 'validation_error',\n                message: 'Missing or invalid moleculeName parameter.',\n            }, { status: 400 });\n        }\n\n        // Call AI service\n        const result = await analyzeMoleculeAction(\n            moleculeName,\n            Number(atomCount || 0),\n            String(userModifications || '')\n        );\n\n        // Success response\n        return NextResponse.json({\n            success: true,\n            ...result,\n        });\n\n    } catch (error: unknown) {\n        console.error('Molecule analysis error:', error);\n        const errorResponse = categorizeError(error);\n        return NextResponse.json(errorResponse, { status: getStatusCode(errorResponse.errorType) });\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAmBA,+EAA+E;AAC/E,uBAAuB;AACvB,+EAA+E;AAE/E,SAAS,gBAAgB,KAAc;IACnC,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;IAErE,IAAI,aAAa,QAAQ,CAAC,UAAU,CAAC,aAAa,QAAQ,CAAC,UAAU,aAAa,QAAQ,CAAC,UAAU,aAAa,QAAQ,CAAC,UAAU,GAAG;QACpI,OAAO;YACH,SAAS;YACT,OAAO;YACP,WAAW;YACX,SAAS;QACb;IACJ;IAEA,IAAI,aAAa,QAAQ,CAAC,YAAY,aAAa,QAAQ,CAAC,uBAAuB;QAC/E,OAAO;YACH,SAAS;YACT,OAAO;YACP,WAAW;YACX,SAAS;QACb;IACJ;IAEA,IAAI,aAAa,QAAQ,CAAC,iBAAiB,aAAa,QAAQ,CAAC,QAAQ;QACrE,OAAO;YACH,SAAS;YACT,OAAO;YACP,WAAW;YACX,SAAS;QACb;IACJ;IAEA,IAAI,aAAa,QAAQ,CAAC,kBAAkB,aAAa,QAAQ,CAAC,YAAY;QAC1E,OAAO;YACH,SAAS;YACT,OAAO;YACP,WAAW;YACX,SAAS;QACb;IACJ;IAEA,OAAO;QACH,SAAS;QACT,OAAO;QACP,WAAW;QACX,SAAS,gBAAgB;IAC7B;AACJ;AAEA,SAAS,cAAc,SAAqC;IACxD,OAAQ;QACJ,KAAK;YAAoB,OAAO;QAChC,KAAK;YAAiB,OAAO;QAC7B,KAAK;YAAkB,OAAO;QAC9B,KAAK;YAAc,OAAO;QAC1B,KAAK;YAAoB,OAAO;QAChC;YAAS,OAAO;IACpB;AACJ;AAMO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,YAAY,EAAE,SAAS,EAAE,iBAAiB,EAAE,GAAG,QAAQ,CAAC;QAEhE,mBAAmB;QACnB,IAAI,CAAC,gBAAgB,OAAO,iBAAiB,UAAU;YACnD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB,SAAS;gBACT,OAAO;gBACP,WAAW;gBACX,SAAS;YACb,GAAG;gBAAE,QAAQ;YAAI;QACrB;QAEA,kBAAkB;QAClB,MAAM,SAAS,MAAM,IAAA,sJAAqB,EACtC,cACA,OAAO,aAAa,IACpB,OAAO,qBAAqB;QAGhC,mBAAmB;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,GAAG,MAAM;QACb;IAEJ,EAAE,OAAO,OAAgB;QACrB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,MAAM,gBAAgB,gBAAgB;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC,eAAe;YAAE,QAAQ,cAAc,cAAc,SAAS;QAAE;IAC7F;AACJ"}}]
}